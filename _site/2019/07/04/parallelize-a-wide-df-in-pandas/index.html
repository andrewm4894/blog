<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Parallelize a wide df in Pandas | Andrew M Blog</title>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>
    <div class="wrapper" style="display: flex; max-width: 1200px; margin: 0 auto; padding: 0 20px;">
      <!-- Main content -->
      <section style="flex: 1; max-width: 800px; margin-right: 40px;">
        <div style="margin-bottom: 2em;">
          <a href="/" style="display: inline-block; padding: 0.5em 1em; background: #f5f5f5; border-radius: 4px; text-decoration: none; color: #333;">
            ← Back to Home
          </a>
        </div>

        

        <h1>Parallelize a wide df in Pandas</h1>

        <p class="post-meta">
          <time datetime="2019-07-04T00:00:00+01:00">Jul 4, 2019
          </time></p>

        
        
        

<h1>Parallelize a wide df in Pandas</h1>

<p class="post-meta">
  <time datetime="2019-07-04T00:00:00+01:00">Jul 4, 2019
  </time></p>



<figure>

<img src="/assets/images/2019-07-04-parallelize-a-wide-df-in-pandas/capture.jpg

<figcaption>

I was going to make a pretty picture.

</figcaption>

</figure>

<p>Sometimes you end up with a very <a href="https://en.wikipedia.org/wiki/Wide_and_narrow_data#Wide">wide</a> pandas dataframe and you are interested in doing the same types of operations (data processing, building a model etc.) but focused on subsets of the columns.</p>

<p>For example if we had a wide df with different time series kpi’s represented as columns then we might want to do something like look at each kpi at a time, apply some pre-processing and build something like an <a href="https://machinelearningmastery.com/arima-for-time-series-forecasting-with-python/">ARIMA</a> time series model perhaps.</p>

<p>This is the situation i found myself in recently and it took me best part of an afternoon to figure out. Usually when i find myself in that situation i try and squeeze out a blog post in case might be useful for someone else or future me.</p>

<figure>

<img src="/assets/images/2019-07-04-parallelize-a-wide-df-in-pandas/code.png

<figcaption>

All the code in one glorious screenshot!

</figcaption>

</figure>

<p><strong>Note</strong>: repository with all code is <a href="https://github.com/andrewm4894/parallelize_wide_df">here</a>. p.s. thanks to <a href="https://towardsdatascience.com/make-your-own-super-pandas-using-multiproc-1c04f41944a1">this</a> and <a href="http://www.racketracer.com/2016/07/06/pandas-in-parallel/">this</a> post that i built off of.</p>

<p>For this example i’m afraid i’m going to use the Iris dataset :0 . This example is as minimal and easy as i could throw together, basically the aim of the code is to:</p>

<ol>
  <li>Build some function to take in a df, do some processing and spit out a new df.</li>
  <li>Have that function be parameterized in some way as might be needed (e.g if you wanted to do slightly different work for one subset of columns).</li>
  <li>Apply that function in parallel across the different subsets of your df that you want to process.</li>
</ol>

<p>There are two main functions of interest here <strong>parallelize_dataframe()</strong> and <strong>do_work()</strong> both of which live in their own file called <a href="https://github.com/andrewm4894/parallelize_wide_df/blob/master/my_functions.py">my_functions.py</a> which can be imported into your jupyter notebook.</p>

<p>https://gist.github.com/andrewm4894/932304809840d6cef7ed5c7fc21b72cb</p>

<p><strong>parallelize_dataframe()</strong> does the below things:</p>

<ol>
  <li>Break out df into a list of df’s based on the col_subsets list passed in as a parameter.</li>
  <li>Wrap the function that was passed in into a partial along with the kwargs (this is how your parameters make it into the do_work() function).</li>
  <li>Use map() from <a href="https://docs.python.org/3/library/multiprocessing.html">multiprocessing</a> to apply the func (along with the args you want to send it) to each subset of columns from your df in parallel.</li>
  <li>Reduce all this back into on final df by joining all the resulting df’s from the map() output into one wide df again (note the assumption here of joining back on the df indexes - they need to be stable and meaningful).</li>
</ol>

<p>The <strong>do_work()</strong> function in this example is just a simple function to add some new columns as examples of types of pandas (or any other) goodness you might want to do. In reality in my case it would be more like a <strong>apply_model()</strong> type function that would take each subset of columns, do some feature extraction, train a model and then also score the data as needed to.</p>

<p>Having the ability to do this for multiple subsets of columns in your wide df can really free up your time to focus on the more important things like dickying around with model parameters and different pre-processing steps :)</p>

<p>That’s pretty much it, a productive afternoon (in the play center with kids i might add) and am quite pleased with myself.</p>

<p><strong>Update:</strong> One addition i made to this as things got more complicated when i went to implement it was the ability to apply different function params to each subset df. For example if you wanted to pass in different parameters to the function for different columns. In the <a href="https://github.com/andrewm4894/parallelize_wide_df/blob/master/do_parallel_zip.ipynb">do_parallel_zip.ipynb</a> and corresponding <a href="https://github.com/andrewm4894/parallelize_wide_df/blob/master/my_functions_zip.py">my_functions_zip.py</a> (i’m calling them “_zip” as they use <a href="https://www.w3schools.com/python/ref_func_zip.asp">zip()</a> to “zip” up both the df_list and the corresponding kwargs to go with it to be unpacked later by <a href="https://github.com/andrewm4894/parallelize_wide_df/blob/master/my_functions_zip.py#L34">do_work_zip()</a>).</p>

<p>To be concrete, if we wanted to multiply the “sepal_…” cols by 100 and the “petal_..” cols by 0.5. We could use the “zip” approach like below (notebook <a href="https://github.com/andrewm4894/parallelize_wide_df/blob/master/do_parallel_zip.ipynb">here</a>):</p>

<p><img src="/assets/images/2019-07-04-parallelize-a-wide-df-in-pandas/capture-2.jpg" alt="" /></p>

<p>Which is using the “zip” approach in <a href="https://github.com/andrewm4894/parallelize_wide_df/blob/master/my_functions_zip.py#L6">parallelize_dataframe_zip()</a></p>

<p><img src="/assets/images/2019-07-04-parallelize-a-wide-df-in-pandas/capture-3.jpg" alt="" /></p>

<p>Where the zipped iterable is then unpacked as needed by the <a href="https://github.com/andrewm4894/parallelize_wide_df/blob/master/my_functions_zip.py#L34">do_work_zip()</a> function:</p>

<p><img src="/assets/images/2019-07-04-parallelize-a-wide-df-in-pandas/capture-4.jpg" alt="" /></p>


<style>
.cover-image {
  margin-bottom: 2em;
  max-width: 100%;
  overflow: hidden;
}

.cover-image img {
  width: 100%;
  height: auto;
  display: block;
}

.post-meta {
  color: #666;
  margin-bottom: 2em;
}

.category {
  font-style: italic;
}

figure {
  margin: 1.5em 0;
  text-align: center;
}

figure img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
}

figcaption {
  color: #666;
  font-style: italic;
  margin-top: 0.5em;
}

img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 1em auto;
}

code {
  padding: 0.2em 0.4em;
  background-color: #f6f8fa;
  border-radius: 3px;
  font-size: 85%;
}

pre code {
  padding: 0;
  background-color: transparent;
}

.language-plaintext {
  color: #24292e;
}

.language-python {
  color: #24292e;
}
</style> 

        <div style="margin-top: 2em; text-align: center;">
          <a href="/" style="display: inline-block; margin: 1em;">← Back to Home</a>
        </div>
      </section>

      <!-- Right sidebar -->
      <aside style="width: 300px; margin-top: 6em;">
        <div style="position: sticky; top: 20px;">
          <h3 style="margin-top: 0;">Recent Posts</h3>
          <div class="posts-list">
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2024/12/19/bolt-new-vs-o1-some-thoughts/" >
                    bolt.new vs o1 - some thoughts
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 19, 2024
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2024/12/03/anomstack-data-engineering-podcast/" >
                    Anomstack - Data Engineering Podcast
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 03, 2024
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2024/03/04/weights-biases-log-keras-model-summary-architecture/" >
                    Weights &amp; Biases - log Keras model summary &amp; architecture
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  March 04, 2024
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/12/20/mlops-community-podcast/" >
                    MLOps Community Podcast!!!
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 20, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/11/06/the-future-of-machine-learning-and-ai-panel-discussion-civo-navigate-europe-23/" >
                    The Future of Machine Learning and AI Panel Discussion - Civo Navigate Europe 23
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  November 06, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/10/25/10-practical-ml-use-cases-in-observability/" >
                    10 Practical ML Use Cases in Observability
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  October 25, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/07/01/malloy-seems-petty-cool/" >
                    Malloy seems petty cool...
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  July 01, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/05/18/painless-anomaly-detection-with-apache-airflow/" >
                    Painless Anomaly Detection with Apache Airflow
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  May 18, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2022/12/22/stripe-webhook-gcp-functions-framework-python/" >
                    Stripe Webhook + GCP Functions Framework (Python)
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 22, 2022
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2022/10/20/colab-to-just-run-some-curl/" >
                    Colab to just run some curl
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  October 20, 2022
                </time>
              </article>
            
            
              <p style="margin-top: 1em;">
                <a href="/" style="color: #666;">View all posts →</a>
              </p>
            
          </div>
        </div>
      </aside>

      <style>
        .cover-image {
          margin-bottom: 2em;
          max-width: 100%;
          overflow: hidden;
        }

        .cover-image img {
          width: 100%;
          height: auto;
          display: block;
        }

        .post-meta {
          color: #666;
          margin-bottom: 2em;
        }

        .category {
          font-style: italic;
        }

        figure {
          margin: 1.5em 0;
          text-align: center;
        }

        figure img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 0 auto;
        }

        figcaption {
          color: #666;
          font-style: italic;
          margin-top: 0.5em;
        }

        img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 1em auto;
        }

        code {
          padding: 0.2em 0.4em;
          background-color: #f6f8fa;
          border-radius: 3px;
          font-size: 85%;
        }

        pre code {
          padding: 0;
          background-color: transparent;
        }

        .language-plaintext {
          color: #24292e;
        }

        .language-python {
          color: #24292e;
        }

        .posts-list h4 a {
          color: #333;
          text-decoration: none;
        }

        .posts-list h4 a:hover {
          color: #267CB9;
        }

        .posts-list .current-post {
          color: #267CB9;
          font-weight: bold;
        }

        @media screen and (max-width: 1000px) {
          .wrapper {
            flex-direction: column;
          }
          
          section {
            margin-right: 0;
          }

          aside {
            width: 100%;
            margin-top: 3em;
          }
        }
      </style>
    </div>
  </body>
</html> 