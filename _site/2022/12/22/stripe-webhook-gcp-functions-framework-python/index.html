<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Stripe Webhook + GCP Functions Framework (Python) | Andrew M Blog</title>
    <link rel="stylesheet" href="/assets/css/style.css?v=">
  </head>
  <body>
    <div class="wrapper" style="display: flex; max-width: 1200px; margin: 0 auto; padding: 0 20px;">
      <!-- Main content -->
      <section style="flex: 1; max-width: 800px; margin-right: 40px;">
        <div style="margin-bottom: 2em;">
          <a href="/" style="display: inline-block; padding: 0.5em 1em; background: #f5f5f5; border-radius: 4px; text-decoration: none; color: #333;">
            ← Back to Home
          </a>
        </div>

        
        <div class="cover-image">
          <img src="/assets/images/2022-12-22-stripe-webhook-gcp-functions-framework-python/stripe-functions-2.png" alt="Stripe Webhook + GCP Functions Framework (Python) cover image">
        </div>
        

        <h1>Stripe Webhook + GCP Functions Framework (Python)</h1>

        <p class="post-meta">
          <time datetime="2022-12-22T00:00:00+00:00">Dec 22, 2022
          </time><span class="categories">
            • Categories: 
            
            <span class="category">cloud</span>
            , 
            
            <span class="category">eng</span>
            
            
          </span></p>

        
        
        
<div class="cover-image">
  <img src="/assets/images/2022-12-22-stripe-webhook-gcp-functions-framework-python/stripe-functions-2.png" alt="Stripe Webhook + GCP Functions Framework (Python) cover image">
</div>


<h1>Stripe Webhook + GCP Functions Framework (Python)</h1>

<p class="post-meta">
  <time datetime="2022-12-22T00:00:00+00:00">Dec 22, 2022
  </time><span class="categories">
    • Categories: 
    
    <span class="category">cloud</span>
    , 
    
    <span class="category">eng</span>
    
    
  </span></p>



<p>This took a couple of days of messing around so decided to make a post out of it.</p>

<p><a href="https://github.com/andrewm4894/stripe-webhook-gcp-function">Here</a> is a minimal enough example repo using <a href="https://www.terraform.io/">Terraform</a> and <a href="https://cloud.google.com/functions/docs/functions-framework">GCP Functions Framework</a> to build a GCP Python function that will receive a <a href="https://stripe.com/docs/webhooks">Stripe webhook</a> event, perform <a href="https://stripe.com/docs/webhooks/signatures">signature verification</a>, and then just <a href="https://github.com/andrewm4894/stripe-webhook-gcp-function/blob/main/python-functions/stripe_webhook/main.py#L34">print the event</a>. You can adapt and build whatever logic you want then on top of this.</p>

<p><strong>TL DR;</strong> if you are looking at the stripe docs and cant figure out why you can run your python function locally but the signature verification fails once deployed to GCP functions (with this generic error message <code class="language-plaintext highlighter-rouge">error.SignatureVerificationError( stripe.error.SignatureVerificationError: No signatures found matching the expected signature for payload</code>) it could be that you need to replace <code class="language-plaintext highlighter-rouge">payload = request.data</code> with <code class="language-plaintext highlighter-rouge">payload = request.data.decode('utf-8')</code>. This i found out after a day or two thanks to <a href="https://stackoverflow.com/a/71756270/1919374">this SO comment</a>.</p>

<p>Most of what might be useful is in the <a href="https://github.com/andrewm4894/stripe-webhook-gcp-function#readme">repo readme</a>, but below i’ll quickly walk through the structure and moving parts.</p>

<h2 id="repo-structure">Repo structure</h2>

<p>Here are the main folders and files involved. Greyed out files are those that might have sensitive info and so are part of the <a href="https://github.com/andrewm4894/stripe-webhook-gcp-function/blob/main/.gitignore">`.gitignore`</a> and so not to be committed to source control. I’ll quickly walkthrough each folder and important files below.</p>

<p><img src="/assets/images/2022-12-22-stripe-webhook-gcp-functions-framework-python/dir-1.png" alt="" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/python-functions</code> - The python code for the function lives in here.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">/stripe_webhook</code> - A folder just for the “stripe_webhook” function.
        <ul>
          <li>
            <p><code class="language-plaintext highlighter-rouge">main.py</code> - Python source code for the function.</p>
          </li>
          <li>
            <p><code class="language-plaintext highlighter-rouge">requirements.txt</code> - Python libraries the function needs to run.</p>
          </li>
        </ul>
      </li>
      <li><code class="language-plaintext highlighter-rouge">/zipped</code> - A local folder of zipped up versions of the python function folders - this zip is what will be loaded to a GCS bucket as the source for the cloud function. This is ignored from source control and not needed.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">/terraform</code> - All terraform related code and configuration files live in here to provision the cloud function and related cloud resources.
    <ul>
      <li>
        <p><code class="language-plaintext highlighter-rouge">conf.tf</code> - A file defining some confidential vars you want available to terraform but not in source control. See conf.example.tf for dummy example and instructions.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">gcp-cloud-functions.tf</code> - Terraform code to provision, configure and deploy all related cloud resources used by the function.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">gcp-secret-manager.tf</code> - Terraform code to define a GCP secret used by the cloud function. The Stripe secret will live in GCP secret manager.</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">terraform.tf</code> - Some standard boilerplate used as part of Terraform set up and when initializing with `terraform init`</p>
      </li>
      <li>
        <p><code class="language-plaintext highlighter-rouge">variables.tf</code> - Some non-sensitive variables we want to use in defining our terraform resources.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">/venv</code> - Our local python development virtual environment used for testing and debugging the function locally using the functions framework cli.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">.env</code> - A env file that will be picked up when running the function locally so that the <code class="language-plaintext highlighter-rouge">stripe_endpoint_secret</code> environment variable will be available locally (coming from <code class="language-plaintext highlighter-rouge">.env</code> file) and when running in GCP cloud (from GCP secrets manager). Also make sure if not under source control, see <code class="language-plaintext highlighter-rouge">.example.env</code> for a dummy example.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">.gitignore</code> - Things we want to make sure we don’t add to source control.</p>
  </li>
  <li><code class="language-plaintext highlighter-rouge">requirements.txt</code> - Python libraries we want to install into our `venv` for local execution and debugging of the function.</li>
</ul>

<h2 id="run-function-locally">Run function locally</h2>

<p>To run the function locally we can use the <a href="https://github.com/GoogleCloudPlatform/functions-framework-python#quickstart-http-function-hello-world">functions framework cli</a> like below:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># run function locally in debug mode on port 8081</span>
functions-framework <span class="nt">--source</span><span class="o">=</span>./python-functions/stripe_webhook/main.py <span class="se">\</span>
  <span class="nt">--target</span><span class="o">=</span>stripe_webhook <span class="se">\</span>
  <span class="nt">--debug</span> <span class="se">\</span>
  <span class="nt">--port</span><span class="o">=</span>8081
</code></pre></div></div>

<p>This should return something like below to show the function running locally on port 8081 (you can use whatever port you want).</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="nx">functions-framework</span><span class="w"> </span><span class="nt">--source</span><span class="o">=.</span><span class="n">/python-functions/stripe_webhook/main.py</span><span class="w"> </span><span class="nx">\</span><span class="w">
  </span><span class="nt">--target</span><span class="o">=</span><span class="n">stripe_webhook</span><span class="w"> </span><span class="nx">\</span><span class="w">
  </span><span class="nt">--debug</span><span class="w"> </span><span class="n">\</span><span class="w">
  </span><span class="nt">--port</span><span class="o">=</span><span class="mi">8081</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Serving</span><span class="w"> </span><span class="nx">Flask</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="s1">'stripe_webhook'</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="nx">mode:</span><span class="w"> </span><span class="nx">on</span><span class="w">
</span><span class="n">WARNING:</span><span class="w"> </span><span class="nx">This</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">development</span><span class="w"> </span><span class="nx">server.</span><span class="w"> </span><span class="nx">Do</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">production</span><span class="w"> </span><span class="nx">deployment.</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">production</span><span class="w"> </span><span class="nx">WSGI</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">instead.</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">addresses</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="p">)</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">http://127.0.0.1:8081</span><span class="w">
</span><span class="n">Press</span><span class="w"> </span><span class="nx">CTRL</span><span class="o">+</span><span class="nx">C</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quit</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Restarting</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">watchdog</span><span class="w"> </span><span class="p">(</span><span class="n">windowsapi</span><span class="p">)</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Debugger</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">active</span><span class="o">!</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Debugger</span><span class="w"> </span><span class="nx">PIN:</span><span class="w"> </span><span class="nx">XXX-XXX</span><span class="w">
</span></code></pre></div></div>

<h2 id="stripe-cli">Stripe CLI</h2>

<h3 id="set-up-local-forwarding">Set up local forwarding</h3>

<p>Once the function is running locally you can use the <a href="https://stripe.com/docs/stripe-cli">stripe cli</a> to (1) forward events to a local endpoint and then (2) trigger some test events to see the response.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># once function is running locally you can forward events to local endpoint</span><span class="w">
</span><span class="n">stripe</span><span class="w"> </span><span class="nx">listen</span><span class="w"> </span><span class="nt">--forward-to</span><span class="w"> </span><span class="nx">localhost:8081</span><span class="w">
</span></code></pre></div></div>

<p>You should see something like this when local forwarding is set up:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\andre</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="nx">listen</span><span class="w"> </span><span class="nt">--forward-to</span><span class="w"> </span><span class="nx">localhost:8081</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">Ready</span><span class="o">!</span><span class="w"> </span><span class="nx">You</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">Stripe</span><span class="w"> </span><span class="nx">API</span><span class="w"> </span><span class="nx">Version</span><span class="w"> </span><span class="p">[</span><span class="mi">2022</span><span class="nt">-11-15</span><span class="p">]</span><span class="o">.</span><span class="w"> </span><span class="nx">Your</span><span class="w"> </span><span class="nx">webhook</span><span class="w"> </span><span class="nx">signing</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">xxx_xxxxxx</span><span class="w"> </span><span class="p">(</span><span class="err">^</span><span class="n">C</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quit</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="create-some-test-events">Create some test events</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># create a test event</span>
stripe trigger payment_intent.succeeded
</code></pre></div></div>

<p>You should see something like this for a successful test event creation:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\andre</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="nx">trigger</span><span class="w"> </span><span class="nx">payment_intent.succeeded</span><span class="w">
</span><span class="n">Setting</span><span class="w"> </span><span class="nx">up</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="nx">for:</span><span class="w"> </span><span class="nx">payment_intent</span><span class="w">
</span><span class="n">Running</span><span class="w"> </span><span class="nx">fixture</span><span class="w"> </span><span class="nx">for:</span><span class="w"> </span><span class="nx">payment_intent</span><span class="w">
</span><span class="n">Trigger</span><span class="w"> </span><span class="nx">succeeded</span><span class="o">!</span><span class="w"> </span><span class="nx">Check</span><span class="w"> </span><span class="nx">dashboard</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="nx">details.</span><span class="w">
</span></code></pre></div></div>

<p>If the function as been invoked successfully then in the window from step 1 above you should see something like this:</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\andre</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">stripe</span><span class="w"> </span><span class="nx">listen</span><span class="w"> </span><span class="nt">--forward-to</span><span class="w"> </span><span class="nx">localhost:8081</span><span class="w">
</span><span class="err">&gt;</span><span class="w"> </span><span class="n">Ready</span><span class="o">!</span><span class="w"> </span><span class="nx">You</span><span class="w"> </span><span class="nx">are</span><span class="w"> </span><span class="nx">using</span><span class="w"> </span><span class="nx">Stripe</span><span class="w"> </span><span class="nx">API</span><span class="w"> </span><span class="nx">Version</span><span class="w"> </span><span class="p">[</span><span class="mi">2022</span><span class="nt">-11-15</span><span class="p">]</span><span class="o">.</span><span class="w"> </span><span class="nx">Your</span><span class="w"> </span><span class="nx">webhook</span><span class="w"> </span><span class="nx">signing</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">xxx_xxxxxx</span><span class="w"> </span><span class="p">(</span><span class="err">^</span><span class="n">C</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quit</span><span class="p">)</span><span class="w">
</span><span class="mi">2022</span><span class="nt">-12-22</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">10</span><span class="w">   </span><span class="o">--</span><span class="err">&gt;</span><span class="w"> </span><span class="n">charge.succeeded</span><span class="w"> </span><span class="p">[</span><span class="n">evt_3MHnvQFE3Qfj39xW1UE7UhT6</span><span class="p">]</span><span class="w">
</span><span class="mi">2022</span><span class="nt">-12-22</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">10</span><span class="w">   </span><span class="o">--</span><span class="err">&gt;</span><span class="w"> </span><span class="n">payment_intent.succeeded</span><span class="w"> </span><span class="p">[</span><span class="n">evt_3MHnvQFE3Qfj39xW1vzt9gAn</span><span class="p">]</span><span class="w">
</span><span class="mi">2022</span><span class="nt">-12-22</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">10</span><span class="w">   </span><span class="o">--</span><span class="err">&gt;</span><span class="w"> </span><span class="n">payment_intent.created</span><span class="w"> </span><span class="p">[</span><span class="n">evt_3MHnvQFE3Qfj39xW1KR01wQ8</span><span class="p">]</span><span class="w">
</span><span class="mi">2022</span><span class="nt">-12-22</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">10</span><span class="w">  </span><span class="err">&lt;</span><span class="o">--</span><span class="w"> </span><span class="p">[</span><span class="mi">200</span><span class="p">]</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w"> </span><span class="p">[</span><span class="n">evt_3MHnvQFE3Qfj39xW1UE7UhT6</span><span class="p">]</span><span class="w">
</span><span class="mi">2022</span><span class="nt">-12-22</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">11</span><span class="w">  </span><span class="err">&lt;</span><span class="o">--</span><span class="w"> </span><span class="p">[</span><span class="mi">200</span><span class="p">]</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w"> </span><span class="p">[</span><span class="n">evt_3MHnvQFE3Qfj39xW1vzt9gAn</span><span class="p">]</span><span class="w">
</span><span class="mi">2022</span><span class="nt">-12-22</span><span class="w"> </span><span class="mi">12</span><span class="p">:</span><span class="mi">31</span><span class="p">:</span><span class="mi">11</span><span class="w">  </span><span class="err">&lt;</span><span class="o">--</span><span class="w"> </span><span class="p">[</span><span class="mi">200</span><span class="p">]</span><span class="w"> </span><span class="n">POST</span><span class="w"> </span><span class="nx">http://localhost:8081</span><span class="w"> </span><span class="p">[</span><span class="n">evt_3MHnvQFE3Qfj39xW1KR01wQ8</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Finally in the window where you triggered the functions framework to run you should just see the a json string with all the event info itself.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">venv</span><span class="p">)</span><span class="w"> </span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\andre\Documents\repos\stripe-webhook-gcp-function</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">functions-framework</span><span class="w"> </span><span class="nt">--source</span><span class="o">=.</span><span class="n">/python-functions/stripe_webhook/main.py</span><span class="w"> </span><span class="nt">--target</span><span class="o">=</span><span class="n">stripe_webhook</span><span class="w"> </span><span class="nt">--debug</span><span class="w"> </span><span class="nt">--port</span><span class="o">=</span><span class="mi">8081</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Serving</span><span class="w"> </span><span class="nx">Flask</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="s1">'stripe_webhook'</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Debug</span><span class="w"> </span><span class="nx">mode:</span><span class="w"> </span><span class="nx">on</span><span class="w">
</span><span class="n">WARNING:</span><span class="w"> </span><span class="nx">This</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">development</span><span class="w"> </span><span class="nx">server.</span><span class="w"> </span><span class="nx">Do</span><span class="w"> </span><span class="nx">not</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">it</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">production</span><span class="w"> </span><span class="nx">deployment.</span><span class="w"> </span><span class="nx">Use</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">production</span><span class="w"> </span><span class="nx">WSGI</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">instead.</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">addresses</span><span class="w"> </span><span class="p">(</span><span class="mf">0.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">0</span><span class="p">)</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">http://127.0.0.1:8081</span><span class="w">

</span><span class="n">Press</span><span class="w"> </span><span class="nx">CTRL</span><span class="o">+</span><span class="nx">C</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">quit</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Restarting</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">watchdog</span><span class="w"> </span><span class="p">(</span><span class="n">windowsapi</span><span class="p">)</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Debugger</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">active</span><span class="o">!</span><span class="w">
 </span><span class="o">*</span><span class="w"> </span><span class="n">Debugger</span><span class="w"> </span><span class="nx">PIN:</span><span class="w"> </span><span class="nx">107-679-323</span><span class="w">
</span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"evt_3MHnvQFE3Qfj39xW1UE7UhT6"</span><span class="p">,</span><span class="w"> </span><span class="s2">"object"</span><span class="p">:</span><span class="w"> </span><span class="s2">"event"</span><span class="p">,</span><span class="w"> </span><span class="s2">"api_version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-11-15"</span><span class="p">,</span><span class="w"> </span><span class="s2">"created"</span><span class="p">:</span><span class="w"> </span><span class="mi">1671712265</span><span class="p">,</span><span class="w"> </span><span class="s2">"data"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"object"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ch_3MHnvQFE3Qfj39xW1ljeXQ0U"</span><span class="p">,</span><span class="w"> </span><span class="s2">"object"</span><span class="p">:</span><span class="w"> </span><span class="s2">"charge"</span><span class="p">,</span><span class="w"> </span><span class="s2">"amount"</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="s2">"amount_captured"</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="p">,</span><span class="w"> </span><span class="s2">"amount_refunded"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> 
</span><span class="o">...</span><span class="w">
</span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Jenny Rosen"</span><span class="p">,</span><span class="w"> </span><span class="s2">"phone"</span><span class="p">:</span><span class="w"> </span><span class="n">null</span><span class="p">,</span><span class="w"> </span><span class="s2">"tracking_number"</span><span class="p">:</span><span class="w"> </span><span class="nx">null</span><span class="p">},</span><span class="w"> </span><span class="s2">"source"</span><span class="p">:</span><span class="w"> </span><span class="n">null</span><span class="p">,</span><span class="w"> </span><span class="s2">"statement_descriptor"</span><span class="p">:</span><span class="w"> </span><span class="nx">null</span><span class="p">,</span><span class="w"> </span><span class="s2">"statement_descriptor_suffix"</span><span class="p">:</span><span class="w"> </span><span class="nx">null</span><span class="p">,</span><span class="w"> </span><span class="s2">"status"</span><span class="p">:</span><span class="w"> </span><span class="s2">"requires_payment_method"</span><span class="p">,</span><span class="w"> </span><span class="s2">"transfer_data"</span><span class="p">:</span><span class="w"> </span><span class="nx">null</span><span class="p">,</span><span class="w"> </span><span class="s2">"transfer_group"</span><span class="p">:</span><span class="w"> </span><span class="nx">null</span><span class="p">}},</span><span class="w"> </span><span class="s2">"livemode"</span><span class="p">:</span><span class="w"> </span><span class="n">false</span><span class="p">,</span><span class="w"> </span><span class="s2">"pending_webhooks"</span><span class="p">:</span><span class="w"> </span><span class="nx">4</span><span class="p">,</span><span class="w"> </span><span class="s2">"request"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"req_BsagVXD6LQwqjH"</span><span class="p">,</span><span class="w"> </span><span class="s2">"idempotency_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"e36a0855-a9e6-441a-b9ca-181632fd43ad"</span><span class="p">},</span><span class="w"> </span><span class="s2">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"payment_intent.created"</span><span class="p">}</span><span class="w">
</span><span class="mf">127.0</span><span class="o">.</span><span class="nf">0</span><span class="o">.</span><span class="nf">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">[</span><span class="mi">22</span><span class="n">/Dec/2022</span><span class="w"> </span><span class="nx">12:31:11</span><span class="p">]</span><span class="w"> </span><span class="s2">"POST / HTTP/1.1"</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">-</span><span class="w">
</span></code></pre></div></div>

<h2 id="thats-it">Thats it</h2>

<p>That’s it, you can then add whatever additional logic you want to handle specific stripe webhook events and control what events make it to this webhook from within the stripe ui itself as needed.</p>

<p>The developer tools and experience with Stripe is really good and being able to so easily run a cloud function locally with realistic test data from stripe using these two cli’s (<code class="language-plaintext highlighter-rouge">stripe</code> and <code class="language-plaintext highlighter-rouge">functions-framework</code>) is really nice, even if it did take me a few days to realize I needed to use that <code class="language-plaintext highlighter-rouge">.decode('utf-8')</code> once the function was deployed to GCP cloud - there’s always going to be something that trips you up a little :)</p>


<style>
.cover-image {
  margin-bottom: 2em;
  max-width: 100%;
  overflow: hidden;
}

.cover-image img {
  width: 100%;
  height: auto;
  display: block;
}

.post-meta {
  color: #666;
  margin-bottom: 2em;
}

.category {
  font-style: italic;
}

figure {
  margin: 1.5em 0;
  text-align: center;
}

figure img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 0 auto;
}

figcaption {
  color: #666;
  font-style: italic;
  margin-top: 0.5em;
}

img {
  max-width: 100%;
  height: auto;
  display: block;
  margin: 1em auto;
}

code {
  padding: 0.2em 0.4em;
  background-color: #f6f8fa;
  border-radius: 3px;
  font-size: 85%;
}

pre code {
  padding: 0;
  background-color: transparent;
}

.language-plaintext {
  color: #24292e;
}

.language-python {
  color: #24292e;
}
</style> 

        <div style="margin-top: 2em; text-align: center;">
          <a href="/" style="display: inline-block; margin: 1em;">← Back to Home</a>
        </div>
      </section>

      <!-- Right sidebar -->
      <aside style="width: 300px; margin-top: 6em;">
        <div style="position: sticky; top: 20px;">
          <h3 style="margin-top: 0;">Recent Posts</h3>
          <div class="posts-list">
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2024/12/19/bolt-new-vs-o1-some-thoughts/" >
                    bolt.new vs o1 - some thoughts
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 19, 2024
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2024/12/03/anomstack-data-engineering-podcast/" >
                    Anomstack - Data Engineering Podcast
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 03, 2024
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2024/03/04/weights-biases-log-keras-model-summary-architecture/" >
                    Weights &amp; Biases - log Keras model summary &amp; architecture
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  March 04, 2024
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/12/20/mlops-community-podcast/" >
                    MLOps Community Podcast!!!
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 20, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/11/06/the-future-of-machine-learning-and-ai-panel-discussion-civo-navigate-europe-23/" >
                    The Future of Machine Learning and AI Panel Discussion - Civo Navigate Europe 23
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  November 06, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/10/25/10-practical-ml-use-cases-in-observability/" >
                    10 Practical ML Use Cases in Observability
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  October 25, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/07/01/malloy-seems-petty-cool/" >
                    Malloy seems petty cool...
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  July 01, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2023/05/18/painless-anomaly-detection-with-apache-airflow/" >
                    Painless Anomaly Detection with Apache Airflow
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  May 18, 2023
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2022/12/22/stripe-webhook-gcp-functions-framework-python/" class="current-post">
                    Stripe Webhook + GCP Functions Framework (Python)
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  December 22, 2022
                </time>
              </article>
            
              <article style="margin-bottom: 1.5em;">
                <h4 style="margin: 0;">
                  <a href="/2022/10/20/colab-to-just-run-some-curl/" >
                    Colab to just run some curl
                  </a>
                </h4>
                <time style="font-size: 0.9em; color: #666;">
                  October 20, 2022
                </time>
              </article>
            
            
              <p style="margin-top: 1em;">
                <a href="/" style="color: #666;">View all posts →</a>
              </p>
            
          </div>
        </div>
      </aside>

      <style>
        .cover-image {
          margin-bottom: 2em;
          max-width: 100%;
          overflow: hidden;
        }

        .cover-image img {
          width: 100%;
          height: auto;
          display: block;
        }

        .post-meta {
          color: #666;
          margin-bottom: 2em;
        }

        .category {
          font-style: italic;
        }

        figure {
          margin: 1.5em 0;
          text-align: center;
        }

        figure img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 0 auto;
        }

        figcaption {
          color: #666;
          font-style: italic;
          margin-top: 0.5em;
        }

        img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 1em auto;
        }

        code {
          padding: 0.2em 0.4em;
          background-color: #f6f8fa;
          border-radius: 3px;
          font-size: 85%;
        }

        pre code {
          padding: 0;
          background-color: transparent;
        }

        .language-plaintext {
          color: #24292e;
        }

        .language-python {
          color: #24292e;
        }

        .posts-list h4 a {
          color: #333;
          text-decoration: none;
        }

        .posts-list h4 a:hover {
          color: #267CB9;
        }

        .posts-list .current-post {
          color: #267CB9;
          font-weight: bold;
        }

        @media screen and (max-width: 1000px) {
          .wrapper {
            flex-direction: column;
          }
          
          section {
            margin-right: 0;
          }

          aside {
            width: 100%;
            margin-top: 3em;
          }
        }
      </style>
    </div>
  </body>
</html> 